#!/bin/bash
# Usage: algo-run elf res_name
set -o pipefail

function trap_ctrlc () {
    echo [1m[31mLoop exists, see log file[0m
    exit 123
}

# Initialise trap to call trap_ctrlc function
# when signal 2 (SIGINT) is received
trap "trap_ctrlc" 2

inp=*.inp
elf=${1:-elf}
res=${2:-test.res}
exec_time=${3:-0}

rm -rf $res
for i in $inp; do
    if ! [ -e "$i" ]; then
        echo [1m[31mEmpty input[0m
        exit 1
    fi
    echo "//-------------------------------------------------------------\\\\"
    out="${i%.inp}".out
    if [ "$exec_time" -eq "0" ]; then
        cmd="ASAN_OPTIONS=detect_leaks=1 ./$elf < $i"
    else
        cmd="time ASAN_OPTIONS=detect_leaks=1 ./$elf < $i"
    fi
    # Ref: https://unix.stackexchange.com/questions/53289/does-segmentation-fault-message-come-under-stderr
    if ! { bash -c "$cmd"; } | tee $out; then
      echo [1m[31mRuntime error, Check source code, Please :\(\-[0m
      exit 124
    else
      cat $out >> $res
    fi
    rm -f $i $out
done
echo "\\\\-------------------------------------------------------------//"

