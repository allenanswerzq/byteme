#!/usr/bin/env bash
set -x
set -e

root=${ALGO:=$HOME/Code/byteme}
pwd=$(basename $PWD)

if [[ "$1" == "gen" ]]; then
  cat "$root/gen.cc" > "$pwd.ge"
  subl "$pwd.ge"
else
  for filepath in $*; do
    if test -d $filepath; then
      echo "==> Problem $filepath already exist."
      exit 1
    fi
    mkdir -p $filepath
    filename=$(basename "$filepath")
    ctime=$(date "+%Y-%m-%d %H:%M:%S")
    sed -e "s/\\\$NAME/$filename/g" \
        -e "s/\\\$DATE/$ctime/g" \
        "$root/template.cc" > $filepath/$filename.cc
    sed -e "s|\\\$TESTS|$filename|g" \
        -e "s|\\\$CMP|$filename|g" \
        -e "s|\\\$GEN|$filename|g" \
        "$root/Makefile" > $filepath/Makefile
    echo "==> Problem $filepath created."
    cd $filepath
    touch ./$filename.in && echo "dummy stuff" > ./$filename.in
    subl ./$filename.in
    # Sleep for a while so that the sublime plugin can work
    # to put the newly created file at the most right position.
    sleep 0.1
    subl ./$filename.cc
    byte-make "test" $filename
  done
fi
